import os
import sys
import subprocess
import hashlib

#for file in os.listdir('contracts'):

def wasm2c(contract_name, wasm_file):
    if not wasm_file.endswith('.wasm'):
        raise Exception('not a wasm file')

    hash = hashlib.sha256()
    with open(wasm_file, 'rb') as f:
        hash.update(f.read())
    hash_hex = hash.hexdigest()

    file_injected = wasm_file.replace('.wasm', '.wasm2')
    src_file = contract_name + '.c'

    wasm_injector = [
        "${CMAKE_BINARY_DIR}/../../libraries/vm/vm_wasm/wasm_injector",
        wasm_file,
        file_injected
    ]

    wasm2c = [
        "/Users/newworld/dev/wasm/wabt/build/wasm2c",
        '-o',
        src_file,
        file_injected
    ]

    try:
        print(' '.join(wasm_injector))
        ret = subprocess.check_output(wasm_injector, stderr=subprocess.STDOUT)
        print(ret.decode('utf8'))

        print(' '.join(wasm2c))
        ret = subprocess.check_output(wasm2c, stderr=subprocess.STDOUT)
        print(ret.decode('utf8'))
    except subprocess.CalledProcessError as e:
        file_injected
        print("error (code {}):".format(e.returncode))
        print(e.output.decode('utf8'))

    with open(src_file, 'r') as f:
        src = f.read()
        src = src.replace('Z_applyZ_vjjj', 'apply_' + hash_hex)
        init = f'void WASM_RT_ADD_PREFIX(init_{hash_hex})(void)'
        src = src.replace('void WASM_RT_ADD_PREFIX(init)(void)', init)
    if src.find('static wasm_rt_memory_t memory') >= 0:
        src += '''
wasm_rt_memory_t* get_memory_%s() {
    return &memory;
}
        '''%(hash_hex,)
    elif src.find('static wasm_rt_memory_t M0') >= 0:
        src += '''
wasm_rt_memory_t* get_memory_%s() {
    return &M0;
}
        '''%(hash_hex,)
    else:
        raise Exception('memory declaration not found!')

    with open(src_file, 'w') as f:
        f.write(src)
    
    header = '''
    void WASM_RT_ADD_PREFIX(init_{0})(void);
    wasm_rt_memory_t* get_memory_{0}(void);
    void (*WASM_RT_ADD_PREFIX(apply_{0}))(u64, u64, u64);

    #define INIT init_{0}
    #define GET_MEMORY get_memory_{0}
    #define APPLY apply_{0}
    '''.format(hash_hex)

    with open(contract_name+'_define.h', 'w') as f:
        f.write('extern "C" {')
        f.write(header)
        f.write('#define WASM_HASH {')
        for c in bytes.fromhex(hash_hex):
            f.write('0x%02x,'%(c,))
        f.write('}')
        f.write('\n}')

contract_name = sys.argv[1]
wasm_file = sys.argv[2]
wasm2c(contract_name, wasm_file)
